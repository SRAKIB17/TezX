# 🔌 `upgradeWebSocket` Middleware

Enable **WebSocket support** across **Node.js**, **Deno**, and **Bun** with runtime-specific optimizations.

---

## Prerequisites

| Runtime | Support | Notes                            |
| ------- | ------- | -------------------------------- |
| Node.js | ✅ Yes   | Requires `ws` (`npm install ws`) |
| Deno    | ✅ Yes   | Native                           |
| Bun     | ✅ Yes   | Native                           |

---

## Import

```ts
// Node.js
import { upgradeWebSocket } from "tezx/node";
// Deno
import { upgradeWebSocket } from "tezx/deno";
// Bun
import { upgradeWebSocket } from "tezx/bun";
```

---

## Types

```ts
type WebSocketEvent = {
  open?: (ws: WebSocket, ctx?: Context) => void;
  message?: (ws: WebSocket, data: string | Buffer | ArrayBuffer) => void;
  close?: (ws: WebSocket, info: { code: number; reason: string }) => void;
  error?: (ws: WebSocket, err: Error | any) => void;
  ping?: (ws: WebSocket, data: Buffer) => void;
  pong?: (ws: WebSocket, data: Buffer) => void;
  drain?: (ws: WebSocket) => void;
};
type WebSocketCallback = (ctx: Context) => WebSocketEvent;
type WebSocketOptions = {
  onUpgradeError?: (err: Error, ctx: Context) => HttpBaseResponse;
};
```

---

## Basic Usage

```ts
app.use(
  "/chat",
  upgradeWebSocket((ctx) => ({
    open(ws) { console.log("Connected"); },
    message(ws, data) { ws.send(`Echo: ${data}`); },
    close(ws, { code, reason }) { console.log("Closed", code, reason); },
    error(ws, err) { console.error(err); },
  }))
);
```

---

## Runtime Setup

### Node.js

```ts
import { createServer } from "http";
import { upgradeWebSocket, mountTezXOnNode } from "tezx/node";

app.use("/chat", upgradeWebSocket(ctx => ({
  open: ws => console.log("Node client connected"),
  message: (ws, msg) => ws.send("Node: " + msg),
})));

const server = createServer();
mountTezXOnNode(app, server);
server.listen(3000);
```

### Deno

```ts
import { upgradeWebSocket } from "tezx/deno";

app.use("/chat", upgradeWebSocket(ctx => ({
  open(ws) { console.log("Deno connected"); },
  message(ws, msg) { ws.send("Deno: " + msg); },
})));

Deno.serve({ port: 3000 }, app.serve);
```

### Bun

```ts
import { upgradeWebSocket, wsHandlers } from "tezx/bun";

app.use("/chat", upgradeWebSocket(ctx => ({
  open(ws) { console.log("Bun connected"); },
  message(ws, msg) { ws.send("Bun: " + msg); },
})));

Bun.serve({ port: 3000, fetch: app.serve, websocket: wsHandlers() });
```

---

## Upgrade Error Handling

```ts
upgradeWebSocket(callback, {
  onUpgradeError: (err, ctx) => ctx.text("Upgrade failed: " + err.message, 400),
});
```

---

## Advanced Events

```ts
message(ws, data) { ws.send("Hello"); },
ping(ws, buffer) { console.log("Ping:", buffer); },
pong(ws, buffer) { console.log("Pong:", buffer); },
drain(ws) { console.log("Backpressure relieved"); }
```

---

## Runtime Features Matrix

| Feature         | Node.js | Deno  | Bun   |
| --------------- | ------- | ----- | ----- |
| Native Upgrade  | ❌ `ws`  | ✅ Yes | ✅ Yes |
| `ping` / `pong` | ✅       | ❌     | ✅     |
| `drain`         | ❌       | ❌     | ✅     |
| Compression     | ✅       | ❌     | ❌     |

---
