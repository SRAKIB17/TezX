# 🔌 `upgradeWebSocket` Middleware

TezX provides **first-class WebSocket support** via the `upgradeWebSocket` middleware, enabling seamless integration across **Node.js**, **Deno**, and **Bun** with runtime-specific optimizations.

---

## ✅ Prerequisites

| Requirement          | Node.js          | Deno       | Bun        |
| -------------------- | ---------------- | ---------- | ---------- |
| Runtime Support      | ✅ Yes            | ✅ Native   | ✅ Native   |
| WebSocket Dependency | ⚠️ Requires `ws` | ✅ No       | ✅ No       |
| TezX App             | ✅ Required       | ✅ Required | ✅ Required |

```bash
# For Node.js only
npm install ws
```

---

## 📁 Runtime-Specific Import

Import the middleware from your target runtime package:

```ts
// Node.js
import { upgradeWebSocket } from "tezx/node";

// Deno
import { upgradeWebSocket } from "tezx/deno";

// Bun
import { upgradeWebSocket } from "tezx/bun";
```

---

## 🧩 Type Definitions

### `WebSocketEvent`

```ts
type WebSocketEvent = {
  open?: (ws: WebSocket, ctx?: Context) => void;
  message?: (ws: WebSocket, data: string | Buffer | ArrayBuffer) => void;
  close?: (ws: WebSocket, info: { code: number; reason: string }) => void;
  error?: (ws: WebSocket, err: Error | any) => void;
  ping?: (ws: WebSocket, data: Buffer) => void;
  pong?: (ws: WebSocket, data: Buffer) => void;
  drain?: (ws: WebSocket) => void;
};
```

### `WebSocketCallback`

```ts
type WebSocketCallback = (ctx: Context) => WebSocketEvent;
```

### `WebSocketOptions`

```ts
type WebSocketOptions = {
  onUpgradeError?: (err: Error, ctx: Context) => HttpBaseResponse;
};
```

---

## 🚀 Basic Usage

```ts
app.use(
  "/chat",
  upgradeWebSocket((ctx) => ({
    open(ws) {
      console.log("WebSocket connected");
    },
    message(ws, data) {
      ws.send(`Echo: ${data}`);
    },
    close(ws, { code, reason }) {
      console.log("Closed with", code, reason);
    },
    error(ws, err) {
      console.error("Error:", err);
    },
  }))
);
```

---

## ⚙️ Runtime Setup

### 🧭 **Node.js + `ws`**

```ts
import { createServer } from "http";
import { upgradeWebSocket, mountTezXOnNode } from "tezx/node";

app.use(
  "/chat",
  upgradeWebSocket((ctx) => ({
    open: (ws) => console.log("Client connected"),
    message: (ws, msg) => ws.send("From Node: " + msg),
  }))
);

const server = createServer();
mountTezXOnNode(app, server);
server.listen(3000);
```

---

### 🦕 **Deno**

```ts
import { upgradeWebSocket } from "tezx/deno";

app.use(
  "/chat",
  upgradeWebSocket((ctx) => ({
    open(ws) {
      console.log("WebSocket ready (Deno)");
    },
    message(ws, msg) {
      ws.send("From Deno: " + msg);
    },
  }))
);

Deno.serve({ port: 3000 }, app.serve);
```

---

### ⚡ **Bun**

```ts
import { upgradeWebSocket } from "tezx/bun";

app.use(
  "/chat",
  upgradeWebSocket((ctx) => ({
    open(ws) {
      console.log("Client connected");
    },
    message(ws, msg) {
      ws.send("From Bun: " + msg);
    },
  }))
);

// Required Bun.serve() handler for WebSocket routing
Bun.serve({
  port: 3000,
  fetch: app.serve,
  reusePort: true,
  websocket: {
    open(ws) {
      return (ws.data as any)?.open?.(ws);
    },
    message(ws, msg) {
      return (ws.data as any)?.message?.(ws, msg);
    },
    close(ws, code, reason) {
      return (ws.data as any)?.close?.(ws, { code, reason });
    },
    ping(ws, data) {
      return (ws.data as any)?.ping?.(ws, data);
    },
    pong(ws, data) {
      return (ws.data as any)?.pong?.(ws, data);
    },
    drain(ws) {
      return (ws.data as any)?.drain?.(ws);
    },
  },
});
```

---

## ❗ Upgrade Error Handling

Use `onUpgradeError` to customize behavior when a connection fails:

```ts
upgradeWebSocket(callback, {
  onUpgradeError: (err, ctx) => {
    return ctx.text("Upgrade failed: " + err.message, 400);
  },
});
```

---

## 🧪 Advanced Events

You can listen to lower-level events like `ping`, `pong`, or `drain` (Bun-only):

```ts
message(ws, data) {
  ws.send("Hello");
},
ping(ws, buffer) {
  console.log("Ping received:", buffer);
},
drain(ws) {
  console.log("Backpressure relieved");
}
```

---

## ✅ Runtime Compatibility Matrix

| Feature                | Node.js (`ws`)  | Deno  | Bun        |
| ---------------------- | --------------- | ----- | ---------- |
| Native Upgrade         | ❌ Requires `ws` | ✅ Yes | ✅ Yes      |
| `ctx.args[2]` Support  | ✅ Yes           | ❌ No  | ❌ No       |
| `.data` Usage          | ❌ N/A           | ❌ N/A | ✅ Required |
| `ping` / `pong` Events | ✅ Yes           | ❌ No  | ✅ Yes      |
| `drain` Event          | ❌ No            | ❌ No  | ✅ Yes      |
| Compression            | ✅ Via `ws`      | ❌ No  | ❌ No       |

---

## 🛡 Best Practices

* Use `ping` and `pong` for health checks in Bun/Node.
* In Bun, always return event handlers via `.data` to enable runtime delegation.
* In Node, attach your server manually using `createServer()` and `mountTezXOnNode`.

---
