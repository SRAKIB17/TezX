## **🚀 Merging Middlewares**

The `mergeMiddleware` function effectively integrates nested middlewares from a new router into the parent router structure. This approach mirrors the way routing systems merge nested routers, ensuring efficient handling of middleware arrays while respecting configurations such as `allowDuplicateMw`.

---

#### **1️⃣ Before Merging**

Initial state of the `RootMiddlewares` router:

```plaintext
RootMiddlewares
 ├── "/test" (Middleware)
 │   ├── middlewares: [m1]
 │   ├── children:
 │       ├── "/test/1" (Middleware)
 │           ├── middlewares: [m2]
```

- `/test`: Contains middleware `[m1]`.
- `/test/1`: Nested route with middleware `[m2]`.

---

#### **2️⃣ New RouterMiddlewares (To Merge)**

Middleware structure from a new router to be merged:

```plaintext
RouterMiddlewares
 ├── "/test" (Middleware)
 │   ├── middlewares: [m3]
 │   ├── children:
 │       ├── "/test/2" (Middleware)
 │           ├── middlewares: [m4]
```

- `/test`: Contains middleware `[m3]`.
- `/test/2`: Nested route with middleware `[m4]`.

---

#### **3️⃣ After Merging**

Resulting structure of `RootMiddlewares` router after merging:

```plaintext
RootMiddlewares
 ├── "/test" (Middleware)
 │   ├── middlewares: [m1, m3]  <-- Merged
 │   ├── children:
 │       ├── "/test/1" (Middleware)
 │           ├── middlewares: [m2]
 │       ├── "/test/2" (Middleware)
 │           ├── middlewares: [m4]  <-- New Middleware Added
```

- `/test`: Middleware arrays `[m1]` and `[m3]` are merged into `[m1, m3]`.
- `/test/1`: Remains unchanged with `[m2]`.
- `/test/2`: A new child route with middleware `[m4]` added.

---

### **🔧 Configuration: `allowDuplicateMw`**

The `allowDuplicateMw` option governs whether duplicate middleware functions are allowed during merging or registration.

```typescript
/**
 * `allowDuplicateMw` determines whether duplicate middleware functions
 * are allowed in the router.
 *
 * - When `true`: Allows the same middleware to be added multiple times.
 * - When `false`: Ensures each middleware is registered only once
 *   per route or application context.
 *
 * @default false
 */
allowDuplicateMw?: boolean;
```

#### **Usage**

```typescript
const app = new TezX({
  logger: logger,
  allowDuplicateMw: true, // Allows duplicate middlewares
  overwriteMethod: false, // Preserves existing method handlers
});
```

#### **Behavior**

- **`allowDuplicateMw: true`**:

  - Middlewares can be registered multiple times for the same route, allowing duplicates.
  - Example after merging with duplicates:

    ```plaintext
    RootMiddlewares
     ├── "/test" (Middleware)
     │   ├── middlewares: [m1, m3, m3]  <-- Duplicates Permitted
    ```

- **`allowDuplicateMw: false`** (default):

  - Duplicates are filtered out, ensuring no repetition in the middleware array.
  - Example after merging:

    ```plaintext
    RootMiddlewares
     ├── "/test" (Middleware)
     │   ├── middlewares: [m1, m3]  <-- No Duplicates
    ```

---

### **🔑 Key Takeaways**

- ✅ **Merges Middleware at the Same Path**: When paths match (e.g., `/test`), middleware arrays are combined, respecting `allowDuplicateMw`.
- ✅ **Recursively Merges Nested Middleware**: Child routes (e.g., `/test/2`) are recursively added or merged into the router.
- ✅ **Memory Optimization**: After merging, middleware arrays are cleared (`middlewares.length = 0`), and child nodes are cleared (`children.clear()`) to optimize memory usage.

---

### **🌟 Final Summary**

- **Recursive Approach**: The function uses a recursive strategy to merge nested middlewares, ensuring all levels of the route tree are handled.
- **Memory Optimization**: Efficient memory usage is achieved by resetting unused arrays and child collections after the merge.

---

### **Example**

#### **Before Merging**

```plaintext
RootMiddlewares
 ├── "/api/users" (Middleware)
 │   ├── middlewares: [authMiddleware]
 │   ├── children:
 │       ├── "/api/users/profile" (Middleware)
 │           ├── middlewares: [logger]
```

#### **New RouterMiddlewares**

```plaintext
RouterMiddlewares
 ├── "/api/users" (Middleware)
 │   ├── middlewares: [rateLimiter]
 │   ├── children:
 │       ├── "/api/users/settings" (Middleware)
 │           ├── middlewares: [audit]
```

#### **After Merging**

```plaintext
RootMiddlewares
 ├── "/api/users" (Middleware)
 │   ├── middlewares: [authMiddleware, rateLimiter]  <-- Merged
 │   ├── children:
 │       ├── "/api/users/profile" (Middleware)
 │           ├── middlewares: [logger]
 │       ├── "/api/users/settings" (Middleware)
 │           ├── middlewares: [audit]  <-- New Child Middleware
```

With `allowDuplicateMw: true`, adding `rateLimiter` again to `/api/users` would result in `[authMiddleware, rateLimiter, rateLimiter]`.

---
