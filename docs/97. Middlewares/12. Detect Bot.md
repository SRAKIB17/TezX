
# Bot Detection Middleware

## Overview

The `detectBot` middleware provides an advanced solution for identifying and handling bot traffic in web applications. It employs multiple detection methods—such as User-Agent analysis, IP address blacklisting, query parameters, rate limiting, and custom logic—to determine if a request originates from a bot. The middleware is highly configurable, allowing developers to define detection criteria, actions, and responses.

### Features

- **Multi-Method Detection**: Combines User-Agent, IP, query, rate limiting, and custom checks.
- **Confidence Scoring**: Uses a threshold-based approach for multi-indicator detection.
- **Flexible Actions**: Supports blocking or custom handling of detected bots.
- **Custom Storage**: Allows pluggable storage for rate limiting data.
- **Debugging Support**: Integrates with `GlobalConfig.debugging` for logging.

---

## Types

### `DetectBotReason`

Enumeration of possible reasons for bot detection.

```typescript
export type DetectBotReason =
  | "User-Agent"
  | "Blacklisted IP"
  | "Query Parameter"
  | "Rate Limiting"
  | "Custom Detector"
  | "Multiple Indicators";
```

### `BotDetectionResult`

Result object returned by the detection process.

```typescript
type BotDetectionResult = {
  isBot: boolean;
  reason?: DetectBotReason;
  indicators: string[];
};
```

- **`isBot`**: Whether the request is identified as a bot.
- **`reason`**: Specific reason for detection (if applicable).
- **`indicators`**: List of triggered detection methods.

### `DetectBotOptions`

Configuration options for customizing bot detection behavior.

```typescript
export type DetectBotOptions = {
  /**
   * 🤖 List of bot-like User-Agent substrings to detect
   * @default ["bot", "spider", "crawl", "slurp"]
   */
  botUserAgents?: string[];

  /**
   * ⚠️ Maximum allowed requests in the time window
   * @default 30
   */
  maxRequests?: number;

  /**
   * ⏱️ Time window in milliseconds for rate limiting
   * @default 60000 (1 minute)
   */
  windowMs?: number;

  /**
   * 🚫 IP blacklist checker
   * @default () => false
   */
    isBlacklisted?: (ctx: Context, remoteAddress: string) => boolean | Promise<boolean>;

  /**
   * 🔍 Query parameter name for bot identification
   * @default "bot"
   */
  queryKeyBot?: string;

  /**
   * 🛡️ Action to take when bot is detected
   * @default "block"
   */
  onBotDetected?:
    | "block"
    | ((ctx: Context, result: BotDetectionResult) => void);

  /**
   * ⚖️ Enable rate-limiting based detection
   * @default false
   */
  enableRateLimiting?: boolean;

  /**
   * 🔎 Custom bot detection logic
   * @default () => false
   */
  customBotDetector?: (ctx: Context) => boolean | Promise<boolean>;

  /**
   * ✉️ Custom response for blocked requests
   */
  customBlockedResponse?: (ctx: Context, result: BotDetectionResult) => void;

  /**
   * 🔄 Custom cache storage implementation
   * @default Map<string, { count: number; resetTime: number }>
   */
  storage?: {
    get: (key: string) => { count: number; resetTime: number } | undefined;
    set: (key: string, value: { count: number; resetTime: number }) => void;
    delete: (key: string) => void;
    clearExpired: () => void;
  };

  /**
   * 📊 Minimum confidence score to consider as bot (0-1)
   * @default 0.5
   */
  confidenceThreshold?: number;
};
```

---

## Function

### `detectBot`

Creates a middleware function for bot detection.

#### Signature

```typescript
export const detectBot = (options: DetectBotOptions = {}): Middleware;
```

#### Parameters

- **`options: DetectBotOptions`** (Optional): Configuration object for detection settings. Defaults to an empty object.

#### Returns

- **`Middleware`**: A function that evaluates requests for bot activity and calls `next()` if not blocked.

#### Description

Implements bot detection by:

1. Collecting request data (User-Agent, IP address, query parameters).
2. Running multiple detection checks (User-Agent, IP address blacklist, rate limiting, etc.).
3. Calculating a confidence score for multi-indicator cases.
4. Triggering a configurable action (block or custom handler) if a bot is detected.
5. Logging detection details via `GlobalConfig.debugging`.

---

## Helper Functions

### `createRateLimitDefaultStorage`

Creates a default in-memory storage for rate limiting.

#### Returns

- Storage object with `get`, `set`, `delete`, and `clearExpired` methods.

#### Parameters

- `ctx`: Request context.
- `key`: Unique identifier (e.g., IP).
- `store`: Storage instance.
- `maxRequests`: Maximum allowed requests.
- `windowMs`: Time window in milliseconds.

---

## Examples

### 1. Basic Usage

```typescript
app.use(detectBot());
app.get("/", (ctx) => ctx.text("Hello"));
```

**Behavior**: Blocks requests with User-Agents containing "bot", "spider", etc.  
**Response (Bot Detected)**:

```json
{ "error": "Bot detected: User-Agent" }
```

---

### 2. Custom IP Blacklist

```typescript
app.use(detectBot({
  isBlacklisted: async (ctx,address) => address.startsWith("192.168"),
  customBlockedResponse: (ctx) => ctx.json({ message: "IP blocked" }, 403),
}));
```

**Request**: From IP `192.168.1.1`  
**Response**:

```json
{ "message": "IP blocked" }
```

---

### 3. Rate Limiting Detection

```typescript
app.use(detectBot({
  enableRateLimiting: true,
  maxRequests: 5,
  windowMs: 10000, // 10 seconds
}));
```

**Behavior**: Blocks after 5 requests within 10 seconds from the same IP.  
**Response (6th Request)**:

```json
{ "error": "Bot detected: Rate Limiting" }
```

---

### 4. Custom Detection Logic

```typescript
app.use(detectBot({
  customBotDetector: async (ctx) => ctx.headers.get("x-bot-flag") === "true",
  onBotDetected: (ctx) => ctx.json({ error: "Custom bot" }, 403),
}));
```

**Request**: With header `X-Bot-Flag: true`  
**Response**:

```json
{ "error": "Custom bot" }
```

---

### 5. Confidence-Based Detection

```typescript
app.use(detectBot({
  botUserAgents: ["crawler"],
  enableRateLimiting: true,
  maxRequests: 10,
  windowMs: 30000,
  confidenceThreshold: 0.7,
}));
```

**Behavior**: Requires a confidence score ≥ 0.7 (e.g., 3+ indicators) to block.  **Default `0.5`**
**Response (Bot Detected)**:

```json
{ "error": "Bot detected: Multiple Indicators" }
```

---

## Best Practices

- **User-Agent**: Customize `botUserAgents` based on known bot patterns.
- **Rate Limiting**: Enable `enableRateLimiting` for high-traffic endpoints.
- **IP Blacklist**: Use `isBlacklisted` with an external reputation service.
- **Confidence**: Adjust `confidenceThreshold` for stricter or lenient detection.
- **Storage**: Provide a custom `storage` for distributed systems (e.g., Redis).

---
