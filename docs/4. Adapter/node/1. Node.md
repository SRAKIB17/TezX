# `nodeAdapter` - Node.js Adapter for TezX Framework

### Overview

The `nodeAdapter` function allows you to create an HTTP server for your TezX application using Node.js's built-in HTTP module. This adapter provides flexibility, supporting both TCP port binding and Unix domain sockets. It is ideal for serving TezX applications with low-level HTTP control or WebSocket support.

### TypeScript Declaration

```ts
import type { ServerOptions } from "node:http";
import { TezXServeOptions, TezX } from "../core/server.js";

export function nodeAdapter<T extends Record<string, any> = {}>(
  TezX: TezX<T>,
  options: ServerOptions & { unix?: string } = {},
): {
  listen(port: number, callback?: (message: string) => void): void;
};
```

---

### Function Signature

```ts
/**
 * Creates a Node.js-compatible HTTP server adapter for TezX.
 *
 * @param TezX - The TezX framework instance. This must be an object with a `.serve(req, options)` method.
 * @param options - Optional configuration for the server, including `ServerOptions` and the optional `unix` option for Unix domain socket.
 *
 * @returns {Object} - Returns an object with a `.listen()` method to start the server.
 *
 * @example
 * const server = nodeAdapter(app);
 * server.listen(3000, (msg) => console.log(msg));
 */
```

---

### Parameters

1. **TezX (T extends Record<string, any>)**:

   - The TezX application instance. This instance should have a `serve(req, options)` method to handle incoming HTTP requests.

2. **options (ServerOptions & { unix?: string })**:
   - Configuration object for the HTTP server. This extends `ServerOptions` from the `node:http` module and can optionally include a `unix` string for Unix domain sockets.
     - **ServerOptions**: Options to configure the behavior of the HTTP server (timeout, headers, connection management).
     - **unix** (optional): A string specifying the path to a Unix domain socket instead of using a TCP port.

---

### Return Value

The function returns an object with a `.listen()` method that starts the server. The `.listen()` method accepts:

1. **port** (number): The port on which the server will listen.
2. **callback** (optional): A function that will be called when the server starts, with a message indicating the server's URL.

---

### Example Usage

#### 1. Using TCP Port Binding

```ts
import { TezX } from "tezx"; // Assuming TezX is properly imported
import { nodeAdapter } from "tezx/adapter";

const app = new TezX();

// Simple TezX routing example
app.get("/", (req, res) => {
  res.send("Hello from TezX!");
});

// Create the Node.js adapter for TezX
const server = nodeAdapter(app);

// Start the server on port 3000
server.listen(3000, (message) => {
  console.log(message); // Server running at http://localhost:3000/
});
```

**Console Output:**

```bash
NodeJS TezX Server running at http://localhost:3000/
```

---

#### 2. Using Unix Domain Socket Binding

This example demonstrates how to use a Unix domain socket instead of a TCP port for communication:

```ts
import { TezX } from "tezx"; // Assuming TezX is properly imported
import { nodeAdapter } from "tezx/adapter";

const app = new TezX();

// Simple TezX routing example
app.get("/", (req, res) => {
  res.send("Hello from TezX!");
});

// Create the Node.js adapter for TezX
const server = nodeAdapter(app, { unix: "/tmp/tezx.sock" });

// Start the server using a Unix socket
server.listen(0, (message) => {
  console.log(message); // Server running at unix:///tmp/tezx.sock
});
```

**Console Output:**

```bash
NodeJS TezX Server running at unix:///tmp/tezx.sock
```

---

### Detailed Behavior

- **WebSocket Support**:
  - The adapter can automatically detect WebSocket requests. If a response contains a `.websocket()` function and the context has a `wsProtocol`, it upgrades the connection to WebSocket and uses the provided callback function.
- **Stream Handling**:

  - If the response body is a readable stream (e.g., for large files or binary data), it pipes the body directly to the response. Otherwise, the body is converted to a `Buffer` and sent as an HTTP response.

- **Error Handling**:

  - The server will throw an error if the `TezX.serve()` method does not return a valid `Response` object.

- **Protocol Detection**:

  - The server detects whether to use `http` or `https` based on SSL configurations. This is useful when the server is running in environments where SSL/TLS is configured.

- **Unix Domain Socket**:
  - If the `unix` option is passed in the `options` parameter, the server listens on a Unix domain socket instead of a TCP/IP port. This is useful for applications that require secure local communication (e.g., with Nginx or systemd).

---

### Available Options (`ServerOptions`)

The `nodeAdapter` function supports all of the options available in the Node.js `ServerOptions` object, such as:

- **requestTimeout**: Timeout for receiving the entire request from the client.
- **maxHeaderSize**: Maximum allowed HTTP request header size.
- **noDelay**: If true, disables Nagleâ€™s algorithm (reduces latency for small packets).
- **keepAliveTimeout**: Timeout for idle connections.
- **insecureHTTPParser**: Whether to use an insecure HTTP parser (not recommended).
- **highWaterMark**: Optional setting for controlling the `highWaterMark` of streams.

### Example

```ts
const server = nodeAdapter(app, {
  requestTimeout: 60000, // 1 minute timeout
  keepAliveTimeout: 10000, // 10 seconds idle timeout
});

server.listen(3000, (msg) => {
  console.log(msg); // Output: NodeJS TezX Server running at http://localhost:3000/
});
```

---

### Considerations

- **Production Readiness**: Ensure that the Unix socket is appropriately configured in a production environment (e.g., proper permissions and socket management).
- **WebSocket Support**: To take advantage of WebSocket support, ensure that your TezX application has the necessary WebSocket handlers (`ctx.wsProtocol` and `.websocket()`).

---
